# 円反転シーン実装計画

## 目的
- ユークリッドジオメトリ内で固定円による反転をリアルタイムに可視化する新しいシーンを追加する。
- 矩形図形（初期形状）をマウスで操作し、シェーダー側で元図形と反転像を描画する。
- 将来的にテクスチャ（画像）反転へ拡張できる設計を準備する。

## スコープ
- 変更対象: `src/render/webgl/**`, `src/ui/scenes/**`, 必要に応じて `src/ui/interactions/**`, `src/ui/stories/**`, `tests/unit/**`, `tests/property/**`.
- 参照のみ: 既存の `sceneDefinitions`, Euclidean パイプライン、 Storybook セットアップ。
- 非対象: CI 設定、受け入れテスト、非 Euclidean シーン。

## 実装ステップ案
1. **要件整理と API 設計**
   - `sceneDefinitions.ts` に新しいシーン ID（仮称: `euclideanCircleInversion`）とメタ情報を追加。
   - 固定円パラメータ（中心・半径）はハードコードで定義し、矩形図形のハンドル構成と初期値を決定。
   - シェーダーに渡す Uniform 構造：固定円、矩形の4頂点（または中心＋サイズ＋回転）、色設定、描画フラグなどを整理。
2. **インタラクションとデータ更新**
   - マウスドラッグで矩形を移動・回転（必要に応じ）できるよう UI ハンドルを設計。
   - ドラッグ結果から矩形の座標データを算出し、GPU Uniform に反映する処理を実装。
3. **シェーダー開発**
   - 新しいフラグメントシェーダーを追加し、以下を描画:
     - 固定円のアウトライン。
     - 元の矩形（塗りつぶし or 枠線）。
     - 円反転後の矩形（像）を計算して描画。
   - 反転式（`p' = center + (radius^2 / ||p-center||^2) * (p - center)`）を GLSL 内で実装。
   - テクスチャマッピングに拡張できるよう、矩形内の UV 計算ロジックを抽象化。
4. **パイプライン統合**
   - 既存の Euclidean WebGL パイプラインへ新シェーダーを組み込み、シーン選択時に適用。
   - Uniform 更新および draw call のセットアップを追加し、固定円・矩形の双方が適切に描画されるよう調整。
5. **シーン定義と UI 表示**
   - `EuclideanSceneHost` から新シーンを選べるようにし、ハンドル情報を初期化。
   - ハンドルの表示・更新とシェーダー Uniform の同期を確認。
6. **Storybook / 手動検証**
   - `Scenes/Circle Inversion` (仮称) の Story を追加し、Play 関数でドラッグ操作 → 反転描画が期待通り変化することを検証。
7. **テスト整備**
   - シーン定義の初期値とハンドル設定をテスト。
   - Uniform パラメータ生成ロジックのユニットテスト。
   - 可能であればシェーダー定数や反転式のサニティチェック（GLSL スナップショットや CPU 版の参照実装）を追加。
8. **ドキュメント**
   - README もしくは Storybook Docs に新シーンの説明と操作方法、将来拡張の方向性を追記。

## 検証観点
- 矩形のドラッグ（平行移動）に応じて元図形・反転像双方がリアルタイムで更新されること。
- 固定円の内外で位置関係が逆転し、距離積が半径二乗になる反転特性が保持されていること。
- パイプラインの既存シーンとの衝突が無い（ID 重複、Uniform 競合など）。
- 将来テクスチャ適用へ拡張する際に必要な Uniform が過不足ないこと。

## 資料
- `ops/ai/prompts/v1/implement_issue.md` (v1)
- `ops/ai/playbooks/dev_flow.md` (v1)

## 補足仕様
- 反転は CPU ではなくシェーダー内で完結させる。CPU は矩形・固定円情報を Uniform として渡すのみ。
- 初期図形は正方形（矩形）とし、テクスチャ（画像）への適用を見据えて UV 計算を設計する。
- 固定円の中心・半径は当面固定値。必要に応じて将来拡張可能な構造にする。
